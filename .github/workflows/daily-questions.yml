name: Daily Questions

on:
  schedule:
    - cron: '1 4 * * *'   # ~00:01 EDT (summer)
    - cron: '1 5 * * *'   # ~00:01 EST (winter)
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: daily5
  cancel-in-progress: false

jobs:
  generate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Generate today's questions (ET-aware)
        run: node scripts/generate-daily.cjs
        shell: bash

      # Append today's questions into used.json (create if missing)
      - name: Update used.json ledger
        shell: bash
        run: |
          set -euo pipefail

          if [ ! -f used.json ]; then
            echo '{ "used": [] }' > used.json
          fi

          node - <<'NODE'
          const fs = require('fs');

          const daily = JSON.parse(fs.readFileSync('daily.json', 'utf8'));
          const usedPath = 'used.json';
          let used;
          try {
            used = JSON.parse(fs.readFileSync(usedPath, 'utf8'));
          } catch {
            used = { used: [] };
          }

          // Prevent double-adding for the same day
          const alreadyLogged = used.used.some(e => e.day === daily.day);
          if (alreadyLogged) {
            console.log('used.json already contains entries for day', daily.day);
            process.exit(0);
          }

          // Minimal record per question (keep it lightweight)
          const entries = (daily.questions || []).map(q => ({
            day: daily.day,
            dayIndex: daily.dayIndex,
            text: q.text,
            correct: q.options[q.correct]
          }));

          used.used.push(...entries);
          fs.writeFileSync(usedPath, JSON.stringify(used, null, 2));
          console.log(`Appended ${entries.length} entries to used.json`);
          NODE

      - name: Commit & push if changed
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          git config user.name "daily5-bot"
          git config user.email "daily5-bot@users.noreply.github.com"

          if ! git diff --quiet --exit-code -- daily.json used.json; then
            git add daily.json used.json
            git commit -m "chore: update daily.json and used.json"
            git push
          else
            echo "No changes to commit."
          fi
